# Server_Software_Component:_SQL_Stored_Procedures - T1505001

| Column Name | Value |
|-------------|-------|
| MITRE Tactic | Persistence |
| MITRE TTP | T1505.001 |
| MITRE Sub-TTP | T1505.001 |
| Name | Server Software Component: SQL Stored Procedures |
| Log Sources to Investigate | Investigate logs from the SQL Server error logs, which may contain information about stored procedure execution and any errors that arise. Monitor database audit logs for changes to stored procedures, especially those that are unexpected. Review application logs from systems interacting with the SQL database, as abnormal interactions might indicate misuse. Check operating system command execution logs if CLR integration and features like xp_cmdshell are enabled. Example log sources include Microsoft SQL Server logs, Windows Event Logs, and any integration logs that capture or audit stored procedure modifications or executions. |
| Key Indicators | Unusual modifications to or execution of stored procedures, especially new procedures added by non-standard users, or those that execute operating system commands. Presence of commands executing via xp_cmdshell or similar features. Unexpected CLR assemblies being loaded or used in conjunction with stored procedures. Patterns of logins or access attempts outside normal business hours, particularly those tied to users with privileges to alter stored procedures. |
| Questions for Analysis | Are the changes to stored procedures associated with a legitimate business process or recent updates? Was the user who modified the stored procedures authorized to do so? Do the modified stored procedures contain calls to execute operating system commands or leverage xp_cmdshell? Are there unusual access patterns or IP addresses associated with the execution of these stored procedures? |
| Decision for Escalation | Escalate to Tier 2 if there are unauthorized changes to stored procedures, detection of xp_cmdshell usage by non-admin personnel, unknown or suspicious CLR assemblies being leveraged, or if there is evidence indicating data exfiltration or further lateral movement potentially linked to these database modifications. |
| Additional Analysis Steps for L1 | Correlate stored procedure modifications with known change management tickets. Verify user access rights against expected roles for stored procedure execution. Check system and network logs for any anomalies coinciding with the stored procedure execution. Assess whether any alerts match known patterns of malicious behavior for stored procedures. |
| T2 Analyst Actions | Conduct a deeper investigation into the modified stored procedures to identify any obfuscated or encoded instructions that could indicate malicious intent. Analyze the security configuration of the database server to identify potential misconfigurations. Cross-reference user activity with other unrelated systems for any coordinated suspicious behavior. Validate the origin and legitimacy of any CLR assemblies linked to suspicious stored procedures. Collaborate with application development teams to confirm unauthorized use of .NET languages for procedures. |
| Containment and Further Analysis | Apply database snapshots for analysis and to preserve evidence. Disable execution of the identified malicious stored procedures and remove unauthorized CLR assemblies. Review and restrict permissions for database users whose accounts were compromised or misused. Temporarily disable features like xp_cmdshell if not required for normal operations. Conduct a full security audit of the SQL Server environment to ensure compliance and secure configurations. Consider endpoint monitoring for signs of persistence mechanisms elsewhere in the environment. |
